name: Check and Build iStoreOS Image

on:
  schedule:
    # 每4小时运行一次（0:00, 4:00, 8:00, 12:00, 16:00, 20:00 UTC）
    - cron: '0 */4 * * *'
  # 允许手动触发
  workflow_dispatch:

permissions: write-all

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make script executable
        run: chmod +x update_istoreos_image.sh

      - name: Check for updates
        id: check-update
        run: |
          ./update_istoreos_image.sh
        shell: bash

      - name: Commit changes if needed
        if: steps.check-update.outputs.updated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/workflows/istoreos.yml
          git commit -m "Update iStoreOS image URL to latest version" || echo "No changes to commit"
          git push "https://${GITHUB_ACTOR}:${{ secrets.WORKFLOW_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_REF#refs/heads/}
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}

      # 如果检测到更新，则触发构建工作流
      - name: Install GitHub CLI
        if: steps.check-update.outputs.updated == 'true'
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Trigger Build Workflow
        if: steps.check-update.outputs.updated == 'true'
        run: |
          echo "检测到新版本，触发构建工作流..."
          # 使用 GitHub CLI 触发工作流
          gh workflow run "Build iStoreOS Scratch Docker Image and Push to Docker Hub"
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}